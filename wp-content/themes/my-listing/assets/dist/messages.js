!function(t){"function"==typeof define&&define.amd?define("messages",t):t()}(function(){"use strict";function n(t,e){for(var s=0;s<e.length;s++){var n=e[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var e,t=function(){function s(t){for(var e in function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),this.data=t)this[e]=t[e];this.$=jQuery,this.post=this.$.post,this.syncStatus=!0,this.startTime=0,this.endTime=0,this.moreMessages=0,this.userPage=1,this.syncDelay=3e3,this.nextSyncDelay=this.syncDelay,this.failedRequests=0,this.failedSyncDelay=6e4,this.settings=ml_msg,this.deletedGroups=[],this.loading=!1,this._blocked=!1,this._loaded={},this._endReached=[],this._queList={},this._activitiesCount={},this._opponents={},jQuery(document).ready(this.sync.bind(this))}return function(t,e,s){e&&n(t.prototype,e),s&&n(t,s)}(s,[{key:"sync",value:function(){var s=this,t=this.post(CASE27.mylisting_ajax_url,{action:"mylisting_sync_messages",st:this.startTime,et:this.endTime,uc:Object.keys(this._opponents).length,up:this.userPage,dg:this.deletedGroups,opponent_id:this.opponentId,async:!0,cache:!1}).done(function(t){if(!t.success||!t.data.hasOwnProperty("ml")||!t.data.hasOwnProperty("st")||!t.data.hasOwnProperty("et")||t.data.st.length<10)return s.failedRequests++,!1;if(10<=t.data.st.toString().length){s.startTime=t.data.st,s.endTime=t.data.et;var e=parseInt(t.data.fr)-Object.keys(t.data.ml).length;s.moreMessages=0<e?e:0}s.$.isEmptyObject(t.data.ml)||s._addMessages(t.data.ml),s.nextSyncDelay=s.syncDelay,s.failedRequests=0}).fail(function(t){s.failedRequests++,s.nextSyncDelay=s.failedRequests*s.failedSyncDelay}).complete(function(){if(s.isLoading=!1,!s.syncStatus||5<=s.failedRequests)return!1;setTimeout(function(){if(void 0!==t._rejected&&t._rejected)return!1;s.sync()},s.nextSyncDelay)});e=t}},{key:"resetSync",value:function(t){this.startTime=0,this.endTime=0,this.cancelSync(),"function"==typeof t&&t(),this.sync()}},{key:"cancelSync",value:function(){e._rejected=!0,e.abort()}},{key:"deleteGroup",value:function(t){return void 0!==this.messages[t.op.id]&&delete this.messages[t.op.id],this.messages=Object.assign({},this.messages),this.post(CASE27.mylisting_ajax_url,{action:"mylisting_delete_conversation",seckey:t.dcn,opponent_id:t.op.id})}},{key:"loadMore",value:function(t,e){var s=this;if(!this.opponentId||-1!==this._endReached.indexOf(this.opponentId))return null;(t=void 0===t)&&this._decreaseActivities(this._activitiesCount[this.opponentId]),this.loading=!0,this.post(CASE27.mylisting_ajax_url,{action:"mylisting_read_conversation",opponent_id:this.opponentId,mark_all_read:t,offset:Object.keys(this.messages[this.opponentId]).length}).done(function(t){return s.loading=!1,s.$.isEmptyObject(t.data.ml)?(s._endReached.push(s.opponentId),"function"==typeof e?e(!0):null):(s._addMessages(t.data.ml),"function"==typeof e?e():null)})}},{key:"send",value:function(t){var e=this,s=this._addToQuelist({opid:this.opponentId,message:t});return this.post(CASE27.mylisting_ajax_url,{action:"mylisting_send_message",receiver_id:this.opponentId,seckey:this.settings.smn,message:t}).done(function(t){if(t&&void 0!==t.success&&!t.success){new MyListing.Dialog({message:t.data,timeout:3e3,dismissable:!0}),e._blocked="long",setTimeout(function(){e._blocked=!1},3e3),e.messages[e.opponentId][s].loading="error"}})}},{key:"deleteMsg",value:function(t){var e=this;for(var s in this.messages[t.op.id])if(t.id===this.messages[t.op.id][s].id){delete this.messages[t.op.id][s];break}return this.messages[t.op.id]=this.messages[t.op.id].filter(function(){return!0}),this.messages=Object.assign({},this.messages),this.post(CASE27.mylisting_ajax_url,{action:"mylisting_delete_message",message_id:t.id,seckey:t.dm}).complete(function(){e.scrollToEnd=!0})}},{key:"setOpponent",value:function(t){this.opponentId=t,this.scrollToEnd=!0,this.messages[t]=this.messages[t]||[],this._loaded[t]=this._loaded[t]||[],this.conversation=this.messages[t]}},{key:"getOpponent",value:function(t){return void 0!==this._opponents[t]&&this._opponents[t]}},{key:"cacheOpponents",value:function(t){for(var e in t)this._opponents[e]=t[e]}},{key:"loadUser",value:function(e,s){var n=this;if(void 0!==this._opponents[e])return s(this._opponents[e]);this.post(CASE27.mylisting_ajax_url,{action:"mylisting_recipients",user_id:e}).done(function(t){return t.success&&t.data[e]?(n.cacheOpponents(t.data),s(n._opponents[e])):s(!1)})}},{key:"toggleBlockStatus",value:function(n,i){var o=this;this.post(CASE27.mylisting_ajax_url,{action:"mylisting_block_sender",opponent_id:n.id,seckey:n.seckey}).done(function(t){if(!t)return!1;if(o._opponents[n.id].blocked=t.data.state,"function"!=typeof i)return null;var e=o.messages[n.id];for(var s in e)e[s].op.blocked=t.data.state;o.messages=Object.assign({},o.messages),i(o._opponents[n.id])})}},{key:"_addToQuelist",value:function(t){var e=t.opid||this.opponentId,s=this.getOpponent(e);return s?(void 0===this.messages[e]&&(this.messages[e]=[],this._loaded[e]=[]),void 0===this._queList[e]&&(this._queList[e]=0),this._queList[e]=this._queList[e]+1,this.messages[e].push({id:"_temp_message",message:t.message,op:s,sender:ml_msg.cu.id,utime:moment().unix(),loading:!0,seen:1}),this.messages=Object.assign({},this.messages),0<this.messages[e].length?this.messages[e].length-1:0):0}},{key:"_decreaseActivities",value:function(t){var s=this;this.activities=this.activities-t,this.activities<0&&(this.activities=0),this.$.each(this.messages[this.opponentId],function(t,e){s.messages[s.opponentId][t].seen=1})}},{key:"_clearQueList",value:function(t){if(void 0===this._queList[t]||this._queList<=0||void 0===this.messages[t])return null;var e=[];for(var s in this.messages[t]){var n=this.messages[t][s];"_temp_message"!==n.id&&e.push(n)}this.messages[t]=e}},{key:"_addMessages",value:function(t){var n=this,i=[];this.$.each(t,function(t,e){var s=e.op.id;if(-1===i.indexOf(s)&&i.push(s),n._opponents[s]=e.op,void 0===n.messages[s]&&(n.messages[s]=[],n._loaded[s]=[],n._activitiesCount[s]=0),-1!==n._loaded[s].indexOf(t))return null;parseInt(e.seen)||e.op.id===n.opponentId||0!==parseInt(e.seen)||parseInt(e.sender)===parseInt(ml_msg.cu.id)?e.seen=1:(n.activities=n.activities+1,n._activitiesCount[s]=n._activitiesCount[s]+1),n._clearQueList(s),n.messages[s].push(e),n._loaded[s].push(t)}),i.forEach(function(t){n.messages[t]=n.messages[t].sort(function(t,e){return t.utime>e.utime?1:-1})}),this.messages=Object.assign({},this.messages)}}]),s}(),s={props:["chat"],template:"#ml-inbox",data:function(){return{loading:!1}},computed:{loadMoreBtn:function(){return this.chat.moreMessages},isMessages:function(){for(var t in this.loading=!1,this.chat.messages)if(this.chat.messages[t].length)return!0;return!1},isLoading:function(){return this.chat.isLoading}},methods:{compose:function(){this.chat.mode="compose"},loadMore:function(){var t=this;this.loading=!0,this.chat.resetSync(function(){t.chat.userPage++})}},components:{messages:{props:["chat","isLoading"],data:function(){return{deleteConfirm:null,blockConfirm:null,blockRequest:!1}},computed:{messageList:function(){var t=[];for(var e in this.chat.messages)if(Object.keys(this.chat.messages[e]).length){var s=this.chat.messages[e][Object.keys(this.chat.messages[e]).length-1],n=0<parseInt(s.seen)||parseInt(s.sender)===parseInt(ml_msg.cu.id);t.push({opid:e,data:s,seen:n})}return t.sort(function(t,e){var s=parseInt(t.data.seen),n=parseInt(e.data.seen);return s===n||parseInt(t.data.sender)===parseInt(ml_msg.cu.id)||parseInt(e.data.sender)===parseInt(ml_msg.cu.id)?t.data.utime<e.data.utime?1:-1:n<s?1:-1})}},methods:{timestamp:function(t){return moment.unix(t).fromNow()},deleteConversation:function(t){if(this.deleteConfirm!==parseInt(t.op.id))return this.deleteConfirm=parseInt(t.op.id);this.chat.deleteGroup(t),this.deleteConfirm=null},isDelete:function(t){return parseInt(t.opid)===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null},open:function(t){if(this.deleteConfirm||this.blockConfirm)return null;this.chat.setOpponent(t.op.id),this.chat.loadMore(),this.chat.mode="conversation"},opponentInfo:function(t){return t.op.name},blockUser:function(t,e){var s=this;if(this.blockConfirm!==parseInt(t.op.id))return this.blockConfirm=parseInt(t.op.id);this.blockRequest=t.op.id,this.chat.toggleBlockStatus(t.op,function(t){s.blockRequest=!1}),this.blockConfirm=null},beingBlocked:function(t){return this.blockRequest&&this.blockRequest===parseInt(t.opid)},isBlocking:function(t){return parseInt(t.opid)===this.blockConfirm},isBlocked:function(t){return this.chat._opponents[t.data.op.id].blocked},cancelBlock:function(){this.blockConfirm=null}},template:"#ml-inbox-messages"}}},i={props:["chat","conversation"],template:"#ml-conversation",data:function(){return this._initialState()},created:function(){this.initialize()},watch:{message:function(){var t=this.message.match(/\n/g),e=t?t.length:1;if(5<e)return null;this.rows=e},"chat.opponentId":function(){this.initialize()}},computed:{isLoading:function(){return this.chat.loading},disable:function(){return!!this.chat._blocked||this.opponent.blocked},disableMessage:function(){return!this.opponent}},methods:{initialize:function(){var e=this;this.endTime(),Object.assign(this.$data,this._initialState()),this.chat.loadUser(this.chat.opponentId,function(t){if(!t)return new MyListing.Dialog({message:ml_msg.strings.notAvailable}),e.inbox();e.opponent=e.chat._opponents[e.chat.opponentId],e.init=!1,e.startTime(),e.$root.mobile.matches||e.$nextTick(function(){jQuery(e.$el).find("#ml-conv-textarea").focus()})})},inbox:function(){this.chat.opponentId=0,this.chat.mode="inbox"},send:function(t){return!(!t||!t.shiftKey)||(this.message=jQuery.trim(this.message),!this.message.length||this.chat._blocked?null:(this.disableSend(),this.$root.chat.scrollToEnd=!0,this.chat.send(this.message),void(this.message="")))},goToInbox:function(){this.chat.opponentId=0,this.chat.mode="inbox"},disableSend:function(){var t=this;this.chat._blocked="short",setTimeout(function(){"short"===t.chat._blocked&&(t.chat._blocked=!1)},ml_msg.sd)},deleteConversation:function(){if(void 0===this.chat.messages[this.chat.opponentId]||!this.chat.messages[this.chat.opponentId].length)return this.goToInbox();var t=this.chat.messages[this.chat.opponentId][0];if(this.deleteConfirm!==parseInt(t.op.id))return this.deleteConfirm=parseInt(t.op.id);this.chat.deleteGroup(t),this.deleteConfirm=null,this.goToInbox()},isDelete:function(){return this.chat.opponentId===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null},startTime:function(){this._interval=setInterval(this.updateTime.bind(this),4e4)},endTime:function(){clearInterval(this._interval)},updateTime:function(){this.messages=Object.assign([],this.conversation)},blockUser:function(){var e=this;if(this.blockConfirm!==parseInt(this.opponent.id))return this.blockConfirm=parseInt(this.opponent.id);this.blockRequest=!0,this.chat.toggleBlockStatus(this.opponent,function(t){e.opponent=t,e.blockRequest=!1}),this.blockConfirm=null},isBlockUser:function(){return parseInt(this.opponent.id)===this.blockConfirm},isBlocked:function(){return this.chat._opponents[this.opponent.id].blocked},cancelBlock:function(){this.blockConfirm=null},_initialState:function(){return{init:!0,opponent:{},messages:{},message:"",deleteConfirm:null,blockConfirm:null,blockRequest:!1,maxLength:ml_msg.mcl,rows:1,_sd:ml_msg.sd}}},components:{messages:{props:["conversation","opponent","chat"],data:function(){return{deleteConfirm:null,_interval:null}},watch:{conversation:function(){this.scrollWindow()}},mounted:function(){this.bindScroll()},computed:{messages:function(){return this.conversation},isMessages:function(){return Object.keys(this.conversation).length},isLoading:function(){return this.chat.loading}},methods:{conversationClass:function(t){return parseInt(t.sender,10)===parseInt(ml_msg.cu.id,10)?"responder-2":"responder-1"},loadingClass:function(t){return"boolean"==typeof t.loading?"fa fa-refresh":"mi error_outline"},timestamp:function(t){return moment.unix(t).fromNow()},deleteMsg:function(t){if(this.deleteConfirm!==parseInt(t.id))return this.deleteConfirm=parseInt(t.id);this.$root.chat.deleteMsg(t)},isDelete:function(t){return parseInt(t.id)===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null},isOpponent:function(t){return parseInt(t.sender)===parseInt(t.op.id)},senderAvatar:function(t){return parseInt(t.sender)===parseInt(t.op.id)?t.op.avatar:ml_msg.cu.avatar},scrollListener:function(t){var e=this;if(50<t.target.scrollTop)return null;this.$root.chat.scrollToEnd=!1,this.unbindScroll(),this.$root.chat.loadMore(!0,function(t){e.$el.scrollTop<55&&(e.$el.scrollTop=55),e.bindScroll()})},bindScroll:function(){this.$el.addEventListener("scroll",this.scrollListener)},unbindScroll:function(){this.$el.removeEventListener("scroll",this.scrollListener)},scrollWindow:function(){if(!this.$root.chat.scrollToEnd)return null;this.$el.scrollTop=this.$el.scrollHeight},linkify:function(t){var e,s,n,i=t.message;return"_temp_message"===t.id?i:(e=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,s=/(^|[^\/])(www\.[\S]+(\b|$))/gim,n=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,i.replace(e,'<a href="$1" target="_blank" rel="nofollow">$1</a>').replace(s,'$1<a href="http://$2" target="_blank" rel="nofollow">$2</a>').replace(n,'<a href="mailto:$1">$1</a>'))}},updated:function(){this.scrollWindow()},template:"#ml-conversation-messages"}},beforeDestroy:function(){this.endTime()}},o={props:["chat"],template:"#ml-compose-message",data:function(){return{opponentId:0,message:"",selected:2,url:CASE27.mylisting_ajax_url,options:null}},computed:{opponentName:function(){return this.chat.getOpponent(this.opponentId).name}},watch:{opponentId:function(t){this.chat.setOpponent(this.opponentId),this.chat.mode="conversation",this.chat.loadMore(),this.message=""}},methods:{inbox:function(){this.chat.mode="inbox"}},components:{select2:{props:["chat","options","value","url"],template:"#ml-opponent-list",data:function(){var s=this,e=this;return{term:null,ajaxOptions:{url:this.url,type:"POST",dataType:"json",delay:250,data:function(t){return e.term=t.term,{action:"mylisting_recipients",term:t.term,page:t.page}},processResults:function(t,e){return t.success&&s.chat.cacheOpponents(t.data),e.page=e.page||1,{results:s.opponents,pagination:{more:30*e.page<[].total_count}}},cache:!0}}},computed:{opponents:function(){var t=[];void 0!==this.term&&this.term.toLowerCase();for(var e in this.chat._opponents)t.push({id:e,text:this.chat._opponents[e].name});return t}},mounted:function(){var e=this;this.el=jQuery(this.$el).select2({data:this.options,placeholder:ml_msg.strings.selectUser,ajax:this.ajaxOptions}).on("change",function(t){e.$parent.opponentId=t.currentTarget.value,e.$emit("input",t.currentTarget.value)})},destroyed:function(){this.el.off().select2("destroy")}}}};window.MyListing.Messages=new Vue({el:"#ml-message-btn",data:{modal:jQuery("#ml-messages-modal"),modal_open:!1,mobile:window.matchMedia("screen and (max-width: 790px)"),chat:new t({mode:!1,messages:{},conversation:[],pending:{},activities:0,opponentId:0,compose:!1,scrollToEnd:!0,allRead:!1,isLoading:!0,_lastMode:"inbox"})},created:function(){var t=this;this.mobile.matches&&(jQuery("#ml-messages-modal").on("shown.bs.modal",function(){jQuery("html, body").addClass("disable-scroll")}),jQuery("#ml-messages-modal").on("hidden.bs.modal",function(){jQuery("html, body").removeClass("disable-scroll")})),jQuery("#ml-messages-modal").on("shown.bs.modal",function(){t.modal_open=!0}),jQuery("#ml-messages-modal").on("hidden.bs.modal",function(){t.modal_open=!1})},mounted:function(){this.$el.addEventListener("touchmove",MyListing.Helpers.debounce(function(){document.body.scrollTop=0},50))},watch:{"chat.activities":function(t){t=parseInt(t),isNaN(t)&&(t=0);var e=jQuery("#ml-chat-activities").html("<span>"+t+"</span>");return t<=0?e.hide():e.show()},"chat.messages":function(t){if(!this.chat.opponentId)return[];this.chat.conversation=this.chat.messages[this.chat.opponentId]},"chat.opponentId":function(t){if(parseInt(t))return this.chat.mode="conversation",t;this.chat.mode="inbox",this.chat.conversation=[]}},methods:{toggle:function(){var t=this.chat._lastMode,e=this.chat.mode;this.chat._lastMode=e,this.chat.mode=t},close:function(){this.modal.modal("hide")},open:function(t){var e=0<arguments.length&&void 0!==t?t:null;this.chat.setOpponent(e),this.modal.modal("show")}},components:{inbox:s,conversation:i,compose:o}})});

//# sourceMappingURL=messages.js.map
